<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="refresh" content="60" />
    <title>Monitoring</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: var(--bs-dark);
        color: var(--bs-light);
      }

      table tr:last-child,
      table tr:last-child td,
      table tr:last-child,
      th {
        border-bottom: none;
      }

      .page-container {
        max-width: 1920px;
        width: 100%;
        padding-right: var(--bs-gutter-x, 0.75rem);
        padding-left: var(--bs-gutter-x, 0.75rem);
        margin-right: auto;
        margin-left: auto;
      }
    </style>
  </head>
  <body>
    <header class="page-container">
      <h1 class="text-center my-3">Monitoring Dashboard</h1>
      <p class="text-end text-light">Stand: <span id="timestamp"></span></p>
    </header>
    <main class="page-container">
      <div class="row">
        <div class="col-2">
          <section class="row my-2 d-flex flex-column">
            <div
              class="card text-light bg-dark d-flex flex-column text-center p-3 border-light shadow"
            >
              <h4>Gesamt PCs</h4>
              <h5 id="computerCount"></h5>
            </div>

            <div
              class="mt-2 card text-light bg-dark d-flex flex-column text-center p-3 border-light shadow"
            >
              <h4>Warnungen Heute</h4>
              <h5 id="warningsCount"></h5>
            </div>

            <div
              class="mt-2 card text-light bg-dark d-flex flex-column text-center p-3 border-light shadow"
            >
              <h4>Ø Warnungen letzte 7 Tage</h4>
              <h5 id="warningsCount7days"></h5>
            </div>

            <div
              class="mt-2 card text-light bg-dark d-flex flex-column text-center p-3 border-light shadow"
            >
              <h4>Ø CPU-Auslastung</h4>
              <h5 id="avgCpuPercent"></h5>
            </div>

            <div
              class="mt-2 card text-light bg-dark d-flex flex-column text-center p-3 border-light shadow"
            >
              <h4>Ø RAM-Auslastung</h4>
              <h5 id="avgRamPercent"></h5>
            </div>
          </section>
        </div>

        <div class="col-10">
          <section class="my-4 row">
            <div class="col-6">
              <h3>Aktuelle Warnungen</h3>
              <table
                class="table table-danger table-striped rounded overflow-hidden"
              >
                <thead>
                  <tr>
                    <th>Hostname</th>
                    <th>Typ</th>
                    <th>Beschreibung</th>
                    <th>Schweregrad</th>
                    <th>Zeitstempel</th>
                  </tr>
                </thead>
                <tbody id="warningsTable"></tbody>
              </table>
            </div>
            <div class="col-6">
              <h3>Neuste Messungen</h3>
              <table
                class="table table-primary table-striped rounded overflow-hidden"
              >
                <thead>
                  <tr>
                    <th>Hostname</th>
                    <th>CPU</th>
                    <th>RAM</th>
                    <th>Disk</th>
                    <th>Uptime</th>
                    <th>Zeitstempel</th>
                  </tr>
                </thead>
                <tbody id="measurementsTable"></tbody>
              </table>
            </div>
          </section>

          <section class="my-4 row">
            <div class="col-3 offset-3">
              <h4>Warnungen nach Typ</h4>
              <canvas id="warningsChart"></canvas>
            </div>
            <div class="col-3">
              <h4>CPU-Verlauf</h4>
              <canvas id="cpuChart"></canvas>
            </div>
          </section>
        </div>
      </div>
    </main>
    <footer></footer>

    <script src="./data.js"></script>
    <script>
      const avgCpuPercentEl = document.getElementById("avgCpuPercent");
      const avgRamPercentEl = document.getElementById("avgRamPercent");
      const computerCountEl = document.getElementById("computerCount");
      const warningsCountEl = document.getElementById("warningsCount");
      const warningsCount7daysEl =
        document.getElementById("warningsCount7days");

      computerCountEl.textContent = data.summary.computerCount;
      warningsCountEl.textContent = data.summary.warningsToday;
      avgCpuPercentEl.textContent = data.summary.avgCpuToday + "%";
      avgRamPercentEl.textContent = data.summary.avgRamUsageToday + "%";
      warningsCount7daysEl.textContent = data.summary.avgWarningsLast7Days;

      //-----------------------------
      const warningsTableEl = document.getElementById("warningsTable");

      // Sort by timestamp descending (optional if backend already does this)
      const sortedWarnings = data.warnings.sort(
        (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
      );

      sortedWarnings.forEach((warn) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${warn.hostname}</td>
          <td>${warn.type}</td>
          <td>${warn.description}</td>
          <td>${warn.severityLevel}</td>
          <td>${new Date(warn.timestamp).toLocaleString("de-DE")}</td>
        `;
        warningsTableEl.appendChild(tr);
      });

      //-----------------------------

      const measurementsTableEl = document.getElementById("measurementsTable");
      measurementsTableEl.innerHTML = ""; // Clear any existing rows

      const sortedMeasurements = data.measurements.sort(
        (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
      );

      sortedMeasurements.forEach((m) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.hostname}</td>
          <td>${m.cpuUsagePercent}%</td>
          <td>${m.ramUsagePercent}%</td>
          <td>${m.diskUsagePercent}%</td>
          <td>${m.uptimeHours} Stunden</td>
          <td>${new Date(m.timestamp).toLocaleString("de-DE")}</td>
        `;
        measurementsTableEl.appendChild(tr);
      });

      //---------------------

      // Set timestamp
      document.getElementById("timestamp").textContent = data.lastUpdated;
      // Platzhalterdaten für Charts
      new Chart(document.getElementById("warningsChart"), {
        type: "pie",
        data: {
          labels: ["HighCPU", "HighRAM", "LowDisk"],
          datasets: [
            {
              data: [5, 3, 2],
              backgroundColor: ["#dc3545", "#ffc107", "#0d6efd"],
            },
          ],
        },
      });

      new Chart(document.getElementById("cpuChart"), {
        type: "line",
        data: {
          labels: ["10:00", "10:05", "10:10", "10:15", "10:20"],
          datasets: [
            {
              label: "CPU % (Host X)",
              data: [35, 42, 55, 48, 60],
              fill: false,
              borderColor: "rgb(75, 192, 192)",
              tension: 0.1,
            },
          ],
        },
      });
    </script>
  </body>
</html>
