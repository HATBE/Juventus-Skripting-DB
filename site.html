<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="refresh" content="60" />
    <title>Monitoring</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: var(--bs-dark);
        color: var(--bs-light);
      }

      table tr:last-child,
      table tr:last-child td,
      table tr:last-child,
      th {
        border-bottom: none;
      }

      .page-container {
        max-width: 1920px;
        width: 100%;
        padding-right: var(--bs-gutter-x, 0.75rem);
        padding-left: var(--bs-gutter-x, 0.75rem);
        margin-right: auto;
        margin-left: auto;
      }
    </style>
  </head>
  <body>
    <header class="page-container">
      <h1 class="text-center my-3">Monitoring Dashboard</h1>
      <p class="text-end text-light">Stand: <span id="timestamp"></span></p>
    </header>
    <main class="page-container">
      <div class="row">
        <div class="col-2">
          <section class="row my-2 d-flex flex-column">
            <div
              class="card text-light bg-dark d-flex flex-column text-center p-3 border-light shadow"
            >
              <h5 class="fw-bold">Gesamt PCs</h5>
              <h5 id="computerCount"></h5>
            </div>

            <div
              class="mt-2 card text-light bg-dark d-flex flex-column text-center p-3 border-light shadow"
            >
              <h5 class="fw-bold">Warnungen Heute</h5>
              <h5 id="warningsCount"></h5>
            </div>

            <div
              class="mt-2 card text-light bg-dark d-flex flex-column text-center p-3 border-light shadow"
            >
              <h5 class="fw-bold">Ø Warnungen letzte 7 Tage (pro Tag)</h5>
              <h5 id="warningsCount7days"></h5>
            </div>

            <div
              class="mt-2 card text-light bg-dark d-flex flex-column text-center p-3 border-light shadow"
            >
              <h5 class="fw-bold">Ø CPU-Auslastung letzte 7 Tage (pro Tag)</h5>
              <h5 id="avgCpuPercent"></h5>
            </div>

            <div
              class="mt-2 card text-light bg-dark d-flex flex-column text-center p-3 border-light shadow"
            >
              <h5 class="fw-bold">Ø RAM-Auslastung letzte 7 Tage (pro Tag)</h5>
              <h5 id="avgRamPercent"></h5>
            </div>
          </section>
        </div>

        <div class="col-10">
          <section class="my-4 row">
            <div class="col-6">
              <h3 class="fw-bold">Aktuelle Warnungen</h3>
              <table
                class="table table-danger table-striped rounded overflow-hidden"
              >
                <thead>
                  <tr>
                    <th>Hostname</th>
                    <th>Typ</th>
                    <th>Beschreibung</th>
                    <th>Schweregrad</th>
                    <th>Zeitstempel</th>
                  </tr>
                </thead>
                <tbody id="warningsTable"></tbody>
              </table>
            </div>
            <div class="col-6">
              <h3 class="fw-bold">Neuste Messungen</h3>
              <table
                class="table table-primary table-striped rounded overflow-hidden"
              >
                <thead>
                  <tr>
                    <th>Hostname</th>
                    <th>CPU</th>
                    <th>RAM</th>
                    <th>Disk</th>
                    <th>Uptime</th>
                    <th>Zeitstempel</th>
                  </tr>
                </thead>
                <tbody id="measurementsTable"></tbody>
              </table>
            </div>
          </section>

          <section class="my-4 row">
            <div class="col-3">
              <h4 class="fw-bold">Warnungen nach Typ</h4>
              <canvas id="warningsChart"></canvas>
            </div>
            <div class="col-3">
              <h4 class="fw-bold">CPU-Verlauf</h4>
              <canvas id="cpuChart"></canvas>
            </div>
            <div class="col-3">
              <h4 class="fw-bold">Ram-Verlauf</h4>
              <canvas id="ramChart"></canvas>
            </div>
          </section>
        </div>
      </div>
    </main>
    <footer></footer>

    <script src="./data.js"></script>
    <script>
      const avgCpuPercentEl = document.getElementById("avgCpuPercent");
      const avgRamPercentEl = document.getElementById("avgRamPercent");
      const computerCountEl = document.getElementById("computerCount");
      const warningsCountEl = document.getElementById("warningsCount");
      const warningsCount7daysEl =
        document.getElementById("warningsCount7days");

      computerCountEl.textContent = data.summary.computerCount;
      warningsCountEl.textContent = data.summary.warningsToday;
      avgCpuPercentEl.textContent =
        data.summary.avgCpuToday == 0
          ? "Keine Daten"
          : data.summary.avgCpuToday + "%";
      avgRamPercentEl.textContent =
        data.summary.avgRamToday == 0
          ? "Keine Daten"
          : data.summary.avgRamToday + "%";
      warningsCount7daysEl.textContent = data.summary.avgWarningsLast7Days;

      //-----------------------------
      const warningsTableEl = document.getElementById("warningsTable");

      // Sort by timestamp descending (optional if backend already does this)
      const sortedWarnings = data.warnings.sort(
        (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
      );

      if (sortedWarnings.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" class="text-center">Keine Warnungen vorhanden</td>`;
        warningsTableEl.appendChild(tr);
      }

      sortedWarnings.forEach((warn) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${warn.hostname}</td>
            <td>${warn.type}</td>
            <td>${warn.description}</td>
            <td>${warn.severityLevel}</td>
            <td>${new Date(warn.timestamp).toLocaleString("de-DE")}</td>
          `;
        warningsTableEl.appendChild(tr);
      });

      //-----------------------------

      const measurementsTableEl = document.getElementById("measurementsTable");
      measurementsTableEl.innerHTML = ""; // Clear any existing rows

      const sortedMeasurements = data.measurements.sort(
        (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
      );

      if (sortedMeasurements.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="text-center">Keine Messungen vorhanden</td>`;
        measurementsTableEl.appendChild(tr);
      }

      sortedMeasurements.forEach((m) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${m.hostname}</td>
            <td>${m.cpuUsagePercent}%</td>
            <td>${m.ramUsagePercent}%</td>
            <td>${m.diskUsagePercent}%</td>
            <td>${m.uptimeHours} Stunden</td>
            <td>${new Date(m.timestamp).toLocaleString("de-DE")}</td>
          `;
        measurementsTableEl.appendChild(tr);
      });

      //---------------------

      // Set timestamp
      document.getElementById("timestamp").textContent = data.lastUpdated;

      // -------------------------------

      //cpu chart
      const cpuChartCanvas = document.getElementById("cpuChart");
      const cpuChartContainer = cpuChartCanvas.parentElement;

      if (!data.cpu7Days || data.cpu7Days.length === 0) {
        cpuChartCanvas.remove();
        const noDataMessage = document.createElement("p");
        noDataMessage.textContent = "Keine Daten für CPU-Verlauf verfügbar";
        noDataMessage.classList.add("text-light");
        cpuChartContainer.appendChild(noDataMessage);
      } else {
        new Chart(cpuChartCanvas, {
          type: "line",
          data: {
            labels: data.cpu7Days.map((entry) =>
              new Date(entry.day).toLocaleDateString("de-DE")
            ),
            datasets: [
              {
                label: "Ø CPU-Auslastung (%)",
                data: data.cpu7Days.map((entry) => entry.avgCpuUsage),
                borderColor: "rgba(255, 99, 132, 1)",
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                fill: true,
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: (value) => value + "%",
                },
              },
            },
          },
        });
      }

      // ram chart

      const ramChartCanvas = document.getElementById("ramChart");
      const ramChartContainer = ramChartCanvas.parentElement;

      if (!data.ram7Days || data.ram7Days.length === 0) {
        // Remove canvas and insert message instead
        ramChartCanvas.remove();
        const noDataMessage = document.createElement("p");
        noDataMessage.textContent = "Keine Daten für RAM-Verlauf verfügbar";
        noDataMessage.classList.add("text-light");
        ramChartContainer.appendChild(noDataMessage);
      } else {
        new Chart(ramChartCanvas, {
          type: "line",
          data: {
            labels: data.ram7Days.map((entry) =>
              new Date(entry.day).toLocaleDateString("de-DE")
            ),
            datasets: [
              {
                label: "Ø RAM-Auslastung (%)",
                data: data.ram7Days.map((entry) => entry.avgRamUsagePercent),
                borderColor: "rgba(54, 162, 235, 1)",
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                fill: true,
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: (value) => value + "%",
                },
              },
            },
          },
        });
      }

      // warnings  chart
      const warningsChartCanvas = document.getElementById("warningsChart");
      const warningsChartContainer = warningsChartCanvas.parentElement;

      if (!data.warningStats || data.warningStats.length === 0) {
        warningsChartCanvas.remove();
        const noDataMessage = document.createElement("p");
        noDataMessage.textContent = "Keine Daten für Warnungstypen verfügbar";
        noDataMessage.classList.add("text-light");
        warningsChartContainer.appendChild(noDataMessage);
      } else {
        new Chart(warningsChartCanvas, {
          type: "pie",
          data: {
            labels: data.warningStats.map((entry) => entry.type),
            datasets: [
              {
                data: data.warningStats.map((entry) => entry.percentage),
                backgroundColor: [
                  "#dc3545", // HighCPU - red
                  "#ffc107", // HighRAM - yellow
                  "#0d6efd", // LowDisk - blue
                  "#198754", // Healthy - green
                  "#6f42c1", // fallback purple
                  "#fd7e14", // fallback orange
                ],
              },
            ],
          },
          options: {
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (ctx) {
                    return `${ctx.label}: ${ctx.raw.toFixed(1)}%`;
                  },
                },
              },
              legend: {
                position: "bottom",
                labels: {
                  color: "#fff",
                },
              },
            },
          },
        });
      }
    </script>
  </body>
</html>
